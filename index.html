<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Central Mesh - Gestor de Pre√ßos v3.22</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
        }
        .hide-for-vendors { }
        .vendors-mode .hide-for-vendors { display: none !important; }
        .price-input {
            transition: all 0.2s;
        }
        .price-input:focus {
            transform: scale(1.05);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.3);
        }
        .price-input.changed {
            background-color: #fef3c7 !important;
            border-color: #f59e0b !important;
        }
        .price-input.empty {
            background-color: #fee2e2 !important;
            border-color: #ef4444 !important;
        }
        .row-empty {
            background-color: #fef2f2 !important;
        }
        .row-changed {
            background-color: #fffbeb !important;
        }
        .cloud-btn {
            transition: all 0.2s;
        }
        .cloud-btn:hover {
            transform: translateY(-2px);
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Navbar -->
    <nav class="bg-orange-600 text-white p-4 no-print">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">Central Mesh | Gestor de Pre√ßos</h1>
            <div class="flex items-center gap-4">
                <button onclick="openCalcConfig()" class="bg-orange-700 hover:bg-orange-800 px-3 py-1 rounded text-sm flex items-center gap-1">
                    ‚öôÔ∏è Par√¢metros de C√°lculo
                </button>
                <button onclick="openSimulator()" class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-sm flex items-center gap-1">
                    üßÆ Simulador de Pre√ßos
                </button>
                <span class="bg-orange-800 px-3 py-1 rounded text-sm font-bold animate-pulse">‚úì v3.22</span>
            </div>
        </div>
    </nav>

    <!-- Modal do Simulador de Pre√ßos -->
    <div id="simulatorModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto p-6">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-lg font-bold text-gray-800">üßÆ Simulador de Pre√ßos</h3>
                <button onclick="closeSimulator()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <div class="mb-6 p-4 bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg">
                <p class="text-sm text-green-800 mb-3"><strong>üíµ Digite o valor em $/m¬≤ para calcular todos os pre√ßos:</strong></p>
                <div class="flex items-center gap-4">
                    <div class="flex-1 max-w-xs">
                        <label class="block text-xs font-bold text-green-700 mb-1">Valor $/m¬≤</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-green-600 font-bold">$</span>
                            <input type="number" step="0.01" id="simInputPrice" value="100" 
                                oninput="calculateSimulation()"
                                class="w-full p-3 pl-8 border-2 border-green-400 rounded-lg text-center font-bold text-2xl text-green-700 focus:ring-4 focus:ring-green-200 focus:border-green-500">
                        </div>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-500 mb-1">Fator Base</p>
                        <p id="simFactorBase" class="text-lg font-bold text-orange-600">9.184</p>
                    </div>
                </div>
            </div>
            
            <!-- Tabela de Resultados -->
            <div class="mb-6">
                <h4 class="font-bold text-gray-700 mb-3 flex items-center gap-2">
                    <span class="bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs">üìä</span>
                    Pre√ßos Calculados
                </h4>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-sm border-collapse">
                        <thead>
                            <tr class="bg-orange-600 text-white">
                                <th class="p-2 border border-orange-700 text-center">Faixa</th>
                                <th class="p-2 border border-orange-700 text-center">Tipo</th>
                                <th class="p-2 border border-orange-700 text-center">Markup</th>
                                <th class="p-2 border border-orange-700 text-center">Divisor</th>
                                <th class="p-2 border border-orange-700 text-center">F√≥rmula</th>
                                <th class="p-2 border border-orange-700 text-center bg-orange-700 font-bold">PRE√áO FINAL</th>
                            </tr>
                        </thead>
                        <tbody id="simResultsBody" class="text-center">
                            <!-- Preenchido via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Resumo Visual -->
            <div class="mb-6 grid grid-cols-2 md:grid-cols-4 gap-3">
                <div class="bg-red-50 border border-red-200 rounded-lg p-3 text-center">
                    <p class="text-xs text-red-600 font-bold mb-1">18% CORTE</p>
                    <p id="simCard18CRT" class="text-xl font-bold text-red-700">-</p>
                </div>
                <div class="bg-red-50 border border-red-200 rounded-lg p-3 text-center">
                    <p class="text-xs text-red-600 font-bold mb-1">18% ROLO</p>
                    <p id="simCard18ROL" class="text-xl font-bold text-red-700">-</p>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-center">
                    <p class="text-xs text-yellow-600 font-bold mb-1">12% CORTE</p>
                    <p id="simCard12CRT" class="text-xl font-bold text-yellow-700">-</p>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-center">
                    <p class="text-xs text-yellow-600 font-bold mb-1">12% ROLO</p>
                    <p id="simCard12ROL" class="text-xl font-bold text-yellow-700">-</p>
                </div>
                <div class="bg-green-50 border border-green-200 rounded-lg p-3 text-center">
                    <p class="text-xs text-green-600 font-bold mb-1">7% CORTE</p>
                    <p id="simCard7CRT" class="text-xl font-bold text-green-700">-</p>
                </div>
                <div class="bg-green-50 border border-green-200 rounded-lg p-3 text-center">
                    <p class="text-xs text-green-600 font-bold mb-1">7% ROLO</p>
                    <p id="simCard7ROL" class="text-xl font-bold text-green-700">-</p>
                </div>
                <div class="bg-gray-100 border border-gray-300 rounded-lg p-3 text-center">
                    <p class="text-xs text-gray-600 font-bold mb-1">CT CORTE</p>
                    <p id="simCardCTCRT" class="text-xl font-bold text-gray-700">-</p>
                </div>
                <div class="bg-gray-100 border border-gray-300 rounded-lg p-3 text-center">
                    <p class="text-xs text-gray-600 font-bold mb-1">CT ROLO</p>
                    <p id="simCardCTROL" class="text-xl font-bold text-gray-700">-</p>
                </div>
            </div>
            
            <!-- F√≥rmula Detalhada -->
            <div class="mb-4 p-3 bg-gray-800 rounded-lg text-white">
                <h4 class="font-bold mb-2 text-orange-400">üìê F√≥rmula Utilizada:</h4>
                <p class="text-xs font-mono text-green-400 mb-2">Pre√ßo = (Fator1 √ó Fator2 √ó Fator3 √ó Markup √ó $/m¬≤) √∑ Divisor</p>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                    <div>
                        <span class="text-gray-400">Fator1:</span>
                        <span id="simShowF1" class="text-white font-bold ml-1">2</span>
                    </div>
                    <div>
                        <span class="text-gray-400">Fator2:</span>
                        <span id="simShowF2" class="text-white font-bold ml-1">5.60</span>
                    </div>
                    <div>
                        <span class="text-gray-400">Fator3:</span>
                        <span id="simShowF3" class="text-white font-bold ml-1">0.82</span>
                    </div>
                    <div>
                        <span class="text-gray-400">Base:</span>
                        <span id="simShowBase" class="text-green-400 font-bold ml-1">9.184</span>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-between">
                <button onclick="openCalcConfig(); closeSimulator();" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded text-sm">
                    ‚öôÔ∏è Alterar Par√¢metros
                </button>
                <div class="flex gap-2">
                    <button onclick="copySimulationResult()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm font-bold">
                        üìã Copiar Resultados
                    </button>
                    <button onclick="closeSimulator()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded text-sm font-bold">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Par√¢metros de C√°lculo -->
    <div id="calcConfigModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto p-6">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-lg font-bold text-gray-800">‚öôÔ∏è Par√¢metros de C√°lculo</h3>
                <button onclick="closeCalcConfig()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded">
                <p class="text-sm text-blue-800"><strong>üìê F√≥rmula Base:</strong></p>
                <p class="text-xs text-blue-700 mt-1 font-mono">Pre√ßo = (Fator1 √ó Fator2 √ó Fator3 √ó Markup √ó $/m¬≤) √∑ Divisor</p>
            </div>
            
            <!-- Fatores Multiplicadores -->
            <div class="mb-6">
                <h4 class="font-bold text-gray-700 mb-3 flex items-center gap-2">
                    <span class="bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs">1</span>
                    Fatores Multiplicadores Base
                </h4>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Fator 1</label>
                        <input type="number" step="0.01" id="calcFactor1" value="2" class="w-full p-2 border border-gray-300 rounded text-center font-bold text-lg">
                        <p class="text-xs text-gray-400 mt-1">Padr√£o: 2</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Fator 2</label>
                        <input type="number" step="0.01" id="calcFactor2" value="5.60" class="w-full p-2 border border-gray-300 rounded text-center font-bold text-lg">
                        <p class="text-xs text-gray-400 mt-1">Padr√£o: 5.60</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Fator 3</label>
                        <input type="number" step="0.01" id="calcFactor3" value="0.82" class="w-full p-2 border border-gray-300 rounded text-center font-bold text-lg">
                        <p class="text-xs text-gray-400 mt-1">Padr√£o: 0.82</p>
                    </div>
                </div>
                <div class="mt-2 p-2 bg-gray-100 rounded text-center">
                    <span class="text-sm text-gray-600">Fator Base Comum = </span>
                    <span id="commonFactorPreview" class="font-bold text-orange-600">9.184</span>
                </div>
            </div>
            
            <!-- Markups Corte/Rolo -->
            <div class="mb-6">
                <h4 class="font-bold text-gray-700 mb-3 flex items-center gap-2">
                    <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs">2</span>
                    Markups (Corte vs Rolo)
                </h4>
                <div class="grid grid-cols-2 gap-4">
                    <div class="p-3 bg-orange-50 border border-orange-200 rounded">
                        <label class="block text-xs font-bold text-orange-700 mb-1">Markup CORTE (CRT)</label>
                        <input type="number" step="0.01" id="calcMarkupCorte" value="1.35" class="w-full p-2 border border-orange-300 rounded text-center font-bold text-lg">
                        <p class="text-xs text-gray-400 mt-1">Padr√£o: 1.35</p>
                    </div>
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded">
                        <label class="block text-xs font-bold text-blue-700 mb-1">Markup ROLO (ROL)</label>
                        <input type="number" step="0.01" id="calcMarkupRolo" value="1.30" class="w-full p-2 border border-blue-300 rounded text-center font-bold text-lg">
                        <p class="text-xs text-gray-400 mt-1">Padr√£o: 1.30</p>
                    </div>
                </div>
            </div>
            
            <!-- Divisores por Faixa de Imposto -->
            <div class="mb-6">
                <h4 class="font-bold text-gray-700 mb-3 flex items-center gap-2">
                    <span class="bg-purple-100 text-purple-700 px-2 py-1 rounded text-xs">3</span>
                    Divisores por Faixa de Imposto
                </h4>
                <div class="grid grid-cols-4 gap-3">
                    <div class="p-3 bg-red-50 border border-red-200 rounded">
                        <label class="block text-xs font-bold text-red-700 mb-1 text-center">18%</label>
                        <input type="number" step="0.0001" id="calcDiv18" value="0.7235" class="w-full p-2 border border-red-300 rounded text-center font-bold">
                        <p class="text-xs text-gray-400 mt-1 text-center">Padr√£o: 0.7235</p>
                    </div>
                    <div class="p-3 bg-yellow-50 border border-yellow-200 rounded">
                        <label class="block text-xs font-bold text-yellow-700 mb-1 text-center">12%</label>
                        <input type="number" step="0.0001" id="calcDiv12" value="0.7835" class="w-full p-2 border border-yellow-300 rounded text-center font-bold">
                        <p class="text-xs text-gray-400 mt-1 text-center">Padr√£o: 0.7835</p>
                    </div>
                    <div class="p-3 bg-green-50 border border-green-200 rounded">
                        <label class="block text-xs font-bold text-green-700 mb-1 text-center">7%</label>
                        <input type="number" step="0.0001" id="calcDiv07" value="0.8335" class="w-full p-2 border border-green-300 rounded text-center font-bold">
                        <p class="text-xs text-gray-400 mt-1 text-center">Padr√£o: 0.8335</p>
                    </div>
                    <div class="p-3 bg-gray-100 border border-gray-300 rounded">
                        <label class="block text-xs font-bold text-gray-700 mb-1 text-center">CT</label>
                        <input type="number" step="0.0001" id="calcDivCT" value="0.9" class="w-full p-2 border border-gray-400 rounded text-center font-bold">
                        <p class="text-xs text-gray-400 mt-1 text-center">Padr√£o: 0.9</p>
                    </div>
                </div>
            </div>
            
            <!-- Preview da F√≥rmula -->
            <div class="mb-6 p-4 bg-gray-800 rounded-lg text-white">
                <h4 class="font-bold mb-2 text-orange-400">üìä Exemplo de C√°lculo ($/m¬≤ = 100):</h4>
                <div class="grid grid-cols-2 gap-2 text-xs font-mono" id="calcPreview">
                    <div>18% CRT: <span class="text-green-400" id="preview18CRT">-</span></div>
                    <div>18% ROL: <span class="text-green-400" id="preview18ROL">-</span></div>
                    <div>12% CRT: <span class="text-yellow-400" id="preview12CRT">-</span></div>
                    <div>12% ROL: <span class="text-yellow-400" id="preview12ROL">-</span></div>
                    <div>7% CRT: <span class="text-blue-400" id="preview7CRT">-</span></div>
                    <div>7% ROL: <span class="text-blue-400" id="preview7ROL">-</span></div>
                    <div>CT CRT: <span class="text-gray-400" id="previewCTCRT">-</span></div>
                    <div>CT ROL: <span class="text-gray-400" id="previewCTROL">-</span></div>
                </div>
            </div>
            
            <div class="flex justify-between">
                <button onclick="resetCalcConfig()" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded text-sm">
                    ‚Ü©Ô∏è Restaurar Padr√µes
                </button>
                <div class="flex gap-2">
                    <button onclick="closeCalcConfig()" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded text-sm">Cancelar</button>
                    <button onclick="saveCalcConfig()" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded text-sm font-bold">üíæ Salvar Par√¢metros</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4">

        <!-- ========================================== -->
        <!-- CONFIGURA√á√ÉO: COLE SUAS URLs AQUI ABAIXO  -->
        <!-- ========================================== -->
        <script>
            // ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
            // ‚ïë  CONFIGURA√á√ÉO DAS URLs DAS PLANILHAS GOOGLE SHEETS             ‚ïë
            // ‚ïë  Cole as URLs das suas planilhas abaixo:                       ‚ïë
            // ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
            
            const CLOUD_CONFIG = {
                // URL da planilha de AN√ÅLISES SIMPLES
                // Exemplo: 'https://script.google.com/macros/s/AKfycbw.../exec'
                URL_SIMPLE: 'https://script.google.com/macros/s/AKfycbycuH6_t7JkVhfSy0k8sqadVtUiJoLfaiROy0l8_3b7sEfveMFQwrzV-K_RoP8V8eSxSg/exec',
                
                // URL da planilha de COMPARATIVOS
                // Exemplo: 'https://script.google.com/macros/s/AKfycbx.../exec'
                URL_COMPARE: 'https://script.google.com/macros/s/AKfycbwvhbLID6yWEQqnLkBWORUR7GNMQdkjhXs4vK4JQF-FPOImduOG5pOu9tIuRvPVevolcg/exec',
                
                // Nome padr√£o do usu√°rio (opcional)
                DEFAULT_USER: 'Usu√°rio'
            };
        </script>
        <!-- ========================================== -->

        <!-- AVISO SE URLs N√ÉO CONFIGURADAS -->
        <section id="step-config-warning" class="hidden bg-red-100 border-2 border-red-400 rounded-lg shadow p-4 mb-6 no-print">
            <div class="flex items-center gap-3">
                <div class="text-3xl">‚ö†Ô∏è</div>
                <div>
                    <h3 class="font-bold text-red-800">URLs das Planilhas N√£o Configuradas</h3>
                    <p class="text-sm text-red-600">Para usar a sincroniza√ß√£o com a nuvem, edite o arquivo index.html e cole as URLs das suas planilhas Google Sheets na se√ß√£o CLOUD_CONFIG.</p>
                </div>
            </div>
        </section>

        <!-- AN√ÅLISES NA NUVEM -->
        <section id="step-cloud-simple" class="hidden no-print">
            <div class="bg-gradient-to-r from-blue-50 to-blue-100 border-2 border-blue-400 rounded-lg shadow p-4 mb-4">
                <div class="flex items-center gap-3 mb-3 border-b border-blue-200 pb-2">
                    <div class="text-2xl">üìä</div>
                    <div class="flex-1">
                        <h3 class="font-bold text-blue-800">An√°lises Simples na Nuvem</h3>
                        <p class="text-xs text-blue-600">Tabelas √∫nicas analisadas</p>
                    </div>
                    <button onclick="refreshCloudAnalyses('simple')" class="text-blue-600 hover:text-blue-800 text-sm">üîÑ Atualizar</button>
                </div>
                <div id="cloudSimpleList" class="space-y-2">Carregando...</div>
            </div>
        </section>

        <section id="step-cloud-compare" class="hidden no-print">
            <div class="bg-gradient-to-r from-green-50 to-green-100 border-2 border-green-400 rounded-lg shadow p-4 mb-6">
                <div class="flex items-center gap-3 mb-3 border-b border-green-200 pb-2">
                    <div class="text-2xl">üîÑ</div>
                    <div class="flex-1">
                        <h3 class="font-bold text-green-800">Comparativos na Nuvem</h3>
                        <p class="text-xs text-green-600">Compara√ß√µes entre tabelas</p>
                    </div>
                    <button onclick="refreshCloudAnalyses('compare')" class="text-green-600 hover:text-green-800 text-sm">üîÑ Atualizar</button>
                </div>
                <div id="cloudCompareList" class="space-y-2">Carregando...</div>
            </div>
        </section>

        <!-- CACHE LOCAL -->
        <section id="step-cached" class="hidden bg-gradient-to-r from-orange-50 to-yellow-50 border-2 border-orange-400 rounded-lg shadow p-4 mb-6 no-print">
            <div class="flex items-center gap-3 mb-3 border-b border-orange-200 pb-2">
                <div class="text-2xl">üíæ</div>
                <div>
                    <h3 class="font-bold text-orange-800">An√°lises Salvas Localmente</h3>
                    <p class="text-xs text-orange-600">Selecione qual an√°lise continuar:</p>
                </div>
            </div>
            <div id="cacheInfo"></div>
        </section>

        <!-- STEP 1: MODO -->
        <section id="step-mode" class="bg-white rounded-lg shadow p-6 mb-6 no-print">
            <h2 class="text-lg font-bold mb-4 text-gray-700">1. Selecione o Modo de Opera√ß√£o</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div onclick="selectMode('simple')" id="modeSimple" class="border-2 border-gray-300 rounded-lg p-6 cursor-pointer hover:border-orange-500 hover:bg-orange-50 transition">
                    <div class="text-center">
                        <div class="text-4xl mb-2">üìä</div>
                        <h3 class="text-lg font-bold text-gray-800">An√°lise Simples</h3>
                        <p class="text-sm text-gray-500 mt-2">Carregar UMA tabela e analisar inconsist√™ncias de pre√ßos</p>
                    </div>
                </div>
                
                <div onclick="selectMode('compare')" id="modeCompare" class="border-2 border-gray-300 rounded-lg p-6 cursor-pointer hover:border-orange-500 hover:bg-orange-50 transition">
                    <div class="text-center">
                        <div class="text-4xl mb-2">üîÑ</div>
                        <h3 class="text-lg font-bold text-gray-800">Comparativo de Tabelas</h3>
                        <p class="text-sm text-gray-500 mt-2">Comparar tabela ATUAL com tabela NOVA</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- STEP 2: IMPORTAR -->
        <section id="step-input" class="hidden bg-white rounded-lg shadow p-6 mb-6 no-print">
            <h2 class="text-lg font-bold mb-4 text-gray-700">2. Importar Arquivo(s) Excel</h2>
            
            <div id="inputSimple" class="hidden">
                <div class="border-2 border-dashed border-orange-300 rounded-lg p-8 text-center bg-orange-50 mb-4">
                    <div class="text-3xl mb-2">üìÅ</div>
                    <p class="font-bold text-gray-700 mb-2">Tabela de Pre√ßos</p>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" class="mb-2">
                </div>
            </div>
            
            <div id="inputCompare" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="border-2 border-dashed border-blue-300 rounded-lg p-6 text-center bg-blue-50">
                        <div class="text-3xl mb-2">üìã</div>
                        <p class="font-bold text-blue-700 mb-2">Tabela ATUAL</p>
                        <input type="file" id="fileCurrentInput" accept=".xlsx,.xls">
                    </div>
                    
                    <div class="border-2 border-dashed border-green-300 rounded-lg p-6 text-center bg-green-50">
                        <div class="text-3xl mb-2">üìÑ</div>
                        <p class="font-bold text-green-700 mb-2">Tabela NOVA</p>
                        <input type="file" id="fileNewInput" accept=".xlsx,.xls">
                    </div>
                </div>
            </div>
            
            <div class="flex gap-4 flex-wrap">
                <button onclick="goBackToMode()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">‚Üê Voltar</button>
                <button onclick="processFiles()" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded font-bold">Analisar Tabela(s)</button>
                <button onclick="downloadTemplate()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Baixar Modelo Excel</button>
            </div>
        </section>

        <!-- STEP 3: AN√ÅLISE -->
        <section id="step-review" class="hidden bg-white rounded-lg shadow p-6 mb-6 no-print">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-lg font-bold text-gray-700">3. An√°lise e Corre√ß√£o</h2>
                    <p class="text-sm text-gray-500">
                        Problemas: <span id="anomalyCount" class="font-bold text-red-600">0</span> | 
                        Vazios: <span id="emptyCount" class="font-bold text-orange-600">0</span> |
                        Total: <span id="totalCount" class="font-bold text-gray-600">0</span>
                        <span id="compareStats" class="hidden">
                            | Alterados: <span id="changedCount" class="font-bold text-blue-600">0</span>
                            | Novos: <span id="newCount" class="font-bold text-green-600">0</span>
                            | Remover: <span id="removedCount" class="font-bold text-red-600">0</span>
                        </span>
                    </p>
                </div>
                <div class="flex gap-2 flex-wrap">
                    <button onclick="saveToCloud()" id="btnSaveCloud" class="hidden bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm cloud-btn">‚òÅÔ∏è Salvar na Nuvem</button>
                    <button onclick="exportComparative()" id="btnExportComparative" class="hidden bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">üìä Exportar Comparativo</button>
                    <button onclick="generateReport()" class="bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded text-sm">Gerar Relat√≥rio Final</button>
                </div>
            </div>

            <!-- FILTROS -->
            <div class="mb-4 p-3 bg-orange-50 rounded border border-orange-200 flex flex-wrap gap-3 items-center">
                <span class="text-xs font-bold text-orange-700">üîç FILTROS:</span>
                <select id="aFilterMaterial" onchange="applyAnalysisFilters()" class="text-xs p-1 border rounded">
                    <option value="">Todos Materiais</option>
                </select>
                <select id="aFilterMesh" onchange="applyAnalysisFilters()" class="text-xs p-1 border rounded">
                    <option value="">Todas Malhas</option>
                </select>
                <select id="aFilterWire" onchange="applyAnalysisFilters()" class="text-xs p-1 border rounded">
                    <option value="">Todos Fios</option>
                </select>
                <select id="aFilterWidth" onchange="applyAnalysisFilters()" class="text-xs p-1 border rounded">
                    <option value="">Todas Larguras</option>
                </select>
                <select id="aFilterStatus" onchange="applyAnalysisFilters()" class="text-xs p-1 border rounded">
                    <option value="">Todos Status</option>
                    <option value="revisar">üî¥ Apenas p/ Revisar</option>
                    <option value="vazio">üü† Apenas Vazios</option>
                    <option value="alterado">üîµ Apenas Alterados</option>
                    <option value="novo">üü¢ Apenas Novos</option>
                    <option value="removido">‚ö´ Apenas p/ Remover</option>
                    <option value="editado">‚úèÔ∏è Apenas Editados</option>
                    <option value="ok">‚úÖ Apenas OK</option>
                </select>
                <button onclick="clearAnalysisFilters()" class="text-xs text-orange-600 underline font-bold">Limpar</button>
                <span id="filteredCount" class="text-xs text-gray-500 ml-auto"></span>
            </div>

            <div class="overflow-x-auto border rounded max-h-[500px]">
                <table class="w-full text-xs">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="p-2 text-left">Status</th>
                            <th class="p-2 text-left">Tipo</th>
                            <th class="p-2 text-left">C√≥digo</th>
                            <th class="p-2 text-left">Material</th>
                            <th class="p-2">Malha</th>
                            <th class="p-2">Fio</th>
                            <th class="p-2">Largura</th>
                            <th class="p-2">$/m¬≤ Anterior</th>
                            <th class="p-2">$/m¬≤ Atual</th>
                            <th class="p-2">Varia√ß√£o</th>
                            <th class="p-2 bg-yellow-50">$/m¬≤ EDITAR</th>
                            <th class="p-2 text-left">Motivo</th>
                            <th class="p-2">A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="analysisBody"></tbody>
                </table>
            </div>
            
            <div class="mt-4 p-3 bg-gray-50 rounded text-xs text-gray-600">
                <strong>Legenda:</strong> 
                <span class="inline-block bg-red-100 text-red-700 px-2 py-0.5 rounded mx-1">Revisar</span>
                <span class="inline-block bg-orange-100 text-orange-700 px-2 py-0.5 rounded mx-1">Vazio</span>
                <span class="inline-block bg-blue-100 text-blue-700 px-2 py-0.5 rounded mx-1">Alterado</span>
                <span class="inline-block bg-green-100 text-green-700 px-2 py-0.5 rounded mx-1">Novo</span>
                <span class="inline-block bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded mx-1">P/ Remover</span>
                <span class="inline-block bg-amber-100 text-amber-700 px-2 py-0.5 rounded mx-1">Editado</span>
            </div>
        </section>

        <!-- STEP 4: RELAT√ìRIO -->
        <section id="step-report" class="hidden">
            <div class="text-center mb-6 border-b-2 border-orange-500 pb-4">
                <h1 class="text-2xl font-bold text-orange-600">TABELA OFICIAL DE PRE√áOS</h1>
                <h2 class="text-lg text-gray-600">Central Mesh</h2>
                <p id="reportDate" class="text-sm text-gray-400"></p>
            </div>

            <div id="filterBar" class="mb-4 p-3 bg-orange-50 rounded border border-orange-200 flex flex-wrap gap-3 items-center no-print">
                <span class="text-xs font-bold text-orange-700">FILTROS:</span>
                <input type="text" id="fCode" onkeyup="applyFilters()" placeholder="C√≥digo..." class="text-xs p-1 border rounded w-24">
                <select id="fMaterial" onchange="applyFilters()" class="text-xs p-1 border rounded"><option value="">Material</option></select>
                <select id="fMesh" onchange="applyFilters()" class="text-xs p-1 border rounded"><option value="">Malha</option></select>
                <select id="fWire" onchange="applyFilters()" class="text-xs p-1 border rounded"><option value="">Fio</option></select>
                <select id="fWidth" onchange="applyFilters()" class="text-xs p-1 border rounded"><option value="">Largura</option></select>
                <button onclick="clearFilters()" class="text-xs text-orange-600 underline">Limpar</button>
                <div class="flex-grow"></div>
                <button onclick="exportExcel()" class="bg-green-600 text-white text-xs px-3 py-1 rounded">Exportar Excel</button>
            </div>

            <div class="overflow-x-auto border rounded">
                <table class="w-full text-xs" id="reportTable">
                    <thead class="bg-orange-600 text-white">
                        <tr>
                            <th class="p-1 border">C√ìDIGO</th>
                            <th class="p-1 border">MATERIAL</th>
                            <th class="p-1 border">MALHA</th>
                            <th class="p-1 border">FIO</th>
                            <th class="p-1 border">LARG.</th>
                            <th class="p-1 border hide-for-vendors">$/m¬≤</th>
                            <th class="p-1 border">18% CRT</th>
                            <th class="p-1 border">18% ROL</th>
                            <th class="p-1 border">12% CRT</th>
                            <th class="p-1 border">12% ROL</th>
                            <th class="p-1 border">7% CRT</th>
                            <th class="p-1 border">7% ROL</th>
                            <th class="p-1 border hide-for-vendors">CT CRT</th>
                            <th class="p-1 border hide-for-vendors">CT ROL</th>
                        </tr>
                    </thead>
                    <tbody id="reportBody"></tbody>
                </table>
            </div>

            <div id="adminButtons" class="mt-6 text-center no-print flex flex-wrap justify-center gap-3">
                <button onclick="window.print()" class="bg-gray-700 text-white px-4 py-2 rounded">üñ®Ô∏è Imprimir PDF</button>
                <button onclick="pubComplete()" class="bg-orange-600 text-white px-4 py-2 rounded font-bold">üåê Publica√ß√£o Completa</button>
                <button onclick="pubVendors()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold">üëî Publica√ß√£o Vendedores</button>
                <button onclick="copyCodeComplete()" class="bg-purple-600 text-white px-4 py-2 rounded">Copiar C√≥digo (Completo)</button>
                <button onclick="copyCodeVendors()" class="bg-pink-600 text-white px-4 py-2 rounded">Copiar C√≥digo (Vendedores)</button>
                <button onclick="location.reload()" class="text-orange-600 underline px-4 py-2">üîÑ Reiniciar</button>
            </div>

            <div id="publicFooter" class="hidden mt-6 text-center text-gray-400 text-xs border-t pt-4">
                Central Mesh - Tabela Oficial de Pre√ßos v3.22
            </div>
        </section>
    </div>

    <script>
        let data = [];
        let currentData = [];
        let newData = [];
        let operationMode = 'simple';
        let currentAnalysisId = null;
        
        // Par√¢metros de C√°lculo (carregados da nuvem ou localStorage)
        let calcParams = {
            factor1: 2,
            factor2: 5.60,
            factor3: 0.82,
            markupCorte: 1.35,
            markupRolo: 1.30,
            div18: 0.7235,
            div12: 0.7835,
            div07: 0.8335,
            divCT: 0.9
        };
        
        // Fun√ß√£o para obter fator comum
        function getCommonFactor() {
            return calcParams.factor1 * calcParams.factor2 * calcParams.factor3;
        }

        // ========== INICIALIZA√á√ÉO ==========
        document.addEventListener('DOMContentLoaded', async function() {
            // Verificar se as URLs est√£o configuradas
            if (!CLOUD_CONFIG.URL_SIMPLE && !CLOUD_CONFIG.URL_COMPARE) {
                document.getElementById('step-config-warning').classList.remove('hidden');
            }
            
            // Carregar par√¢metros (primeiro da nuvem, depois local)
            await loadCalcParamsFromCloud();
            
            // Carregar an√°lises da nuvem
            loadCloudAnalyses();
            
            // Verificar cache local
            checkCachedData();
        });

        // ========== PAR√ÇMETROS DE C√ÅLCULO ==========
        async function loadCalcParamsFromCloud() {
            if (!CLOUD_CONFIG.URL_SIMPLE) {
                loadCalcParamsFromLocal();
                return;
            }
            
            try {
                const response = await fetch(CLOUD_CONFIG.URL_SIMPLE + '?action=loadConfig&key=calcParams');
                const result = await response.json();
                
                if (result && result.data) {
                    calcParams = JSON.parse(result.data);
                    console.log('‚úÖ Par√¢metros carregados da nuvem:', calcParams);
                    // Tamb√©m salvar localmente como backup
                    localStorage.setItem('centralMesh_calcParams', JSON.stringify(calcParams));
                } else {
                    loadCalcParamsFromLocal();
                }
            } catch(e) {
                console.log('‚ö†Ô∏è N√£o foi poss√≠vel carregar da nuvem, usando local:', e);
                loadCalcParamsFromLocal();
            }
        }
        
        function loadCalcParamsFromLocal() {
            try {
                const saved = localStorage.getItem('centralMesh_calcParams');
                if (saved) {
                    calcParams = JSON.parse(saved);
                    console.log('üíæ Par√¢metros carregados do local:', calcParams);
                }
            } catch(e) {
                console.log('Usando par√¢metros padr√£o');
            }
        }
        
        function openCalcConfig() {
            document.getElementById('calcFactor1').value = calcParams.factor1;
            document.getElementById('calcFactor2').value = calcParams.factor2;
            document.getElementById('calcFactor3').value = calcParams.factor3;
            document.getElementById('calcMarkupCorte').value = calcParams.markupCorte;
            document.getElementById('calcMarkupRolo').value = calcParams.markupRolo;
            document.getElementById('calcDiv18').value = calcParams.div18;
            document.getElementById('calcDiv12').value = calcParams.div12;
            document.getElementById('calcDiv07').value = calcParams.div07;
            document.getElementById('calcDivCT').value = calcParams.divCT;
            updateCalcPreview();
            document.getElementById('calcConfigModal').classList.remove('hidden');
            
            // Listeners para preview em tempo real
            document.querySelectorAll('#calcConfigModal input').forEach(input => {
                input.addEventListener('input', updateCalcPreview);
            });
        }
        
        function closeCalcConfig() {
            document.getElementById('calcConfigModal').classList.add('hidden');
        }
        
        function updateCalcPreview() {
            const f1 = parseFloat(document.getElementById('calcFactor1').value) || 2;
            const f2 = parseFloat(document.getElementById('calcFactor2').value) || 5.60;
            const f3 = parseFloat(document.getElementById('calcFactor3').value) || 0.82;
            const mCorte = parseFloat(document.getElementById('calcMarkupCorte').value) || 1.35;
            const mRolo = parseFloat(document.getElementById('calcMarkupRolo').value) || 1.30;
            const d18 = parseFloat(document.getElementById('calcDiv18').value) || 0.7235;
            const d12 = parseFloat(document.getElementById('calcDiv12').value) || 0.7835;
            const d07 = parseFloat(document.getElementById('calcDiv07').value) || 0.8335;
            const dCT = parseFloat(document.getElementById('calcDivCT').value) || 0.9;
            
            const commonFactor = f1 * f2 * f3;
            document.getElementById('commonFactorPreview').textContent = commonFactor.toFixed(4);
            
            // Exemplo com $/m¬≤ = 100
            const base = 100;
            const numCorte = commonFactor * mCorte * base;
            const numRolo = commonFactor * mRolo * base;
            
            document.getElementById('preview18CRT').textContent = fmt(numCorte / d18);
            document.getElementById('preview18ROL').textContent = fmt(numRolo / d18);
            document.getElementById('preview12CRT').textContent = fmt(numCorte / d12);
            document.getElementById('preview12ROL').textContent = fmt(numRolo / d12);
            document.getElementById('preview7CRT').textContent = fmt(numCorte / d07);
            document.getElementById('preview7ROL').textContent = fmt(numRolo / d07);
            document.getElementById('previewCTCRT').textContent = fmt(numCorte / dCT);
            document.getElementById('previewCTROL').textContent = fmt(numRolo / dCT);
        }
        
        async function saveCalcConfig() {
            calcParams = {
                factor1: parseFloat(document.getElementById('calcFactor1').value) || 2,
                factor2: parseFloat(document.getElementById('calcFactor2').value) || 5.60,
                factor3: parseFloat(document.getElementById('calcFactor3').value) || 0.82,
                markupCorte: parseFloat(document.getElementById('calcMarkupCorte').value) || 1.35,
                markupRolo: parseFloat(document.getElementById('calcMarkupRolo').value) || 1.30,
                div18: parseFloat(document.getElementById('calcDiv18').value) || 0.7235,
                div12: parseFloat(document.getElementById('calcDiv12').value) || 0.7835,
                div07: parseFloat(document.getElementById('calcDiv07').value) || 0.8335,
                divCT: parseFloat(document.getElementById('calcDivCT').value) || 0.9
            };
            
            // Salvar localmente
            localStorage.setItem('centralMesh_calcParams', JSON.stringify(calcParams));
            
            // Salvar na nuvem se URL configurada
            if (CLOUD_CONFIG.URL_SIMPLE) {
                try {
                    const payload = {
                        action: 'saveConfig',
                        key: 'calcParams',
                        data: JSON.stringify(calcParams)
                    };
                    
                    await fetch(CLOUD_CONFIG.URL_SIMPLE, {
                        method: 'POST',
                        mode: 'cors',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify(payload)
                    });
                    
                    alert('‚úÖ Par√¢metros salvos localmente e na nuvem!');
                } catch(e) {
                    alert('‚úÖ Par√¢metros salvos localmente.\n‚ö†Ô∏è N√£o foi poss√≠vel salvar na nuvem: ' + e.message);
                }
            } else {
                alert('‚úÖ Par√¢metros salvos localmente!');
            }
            
            closeCalcConfig();
        }
        
        function resetCalcConfig() {
            if (!confirm('Restaurar todos os par√¢metros para os valores padr√£o?')) return;
            document.getElementById('calcFactor1').value = 2;
            document.getElementById('calcFactor2').value = 5.60;
            document.getElementById('calcFactor3').value = 0.82;
            document.getElementById('calcMarkupCorte').value = 1.35;
            document.getElementById('calcMarkupRolo').value = 1.30;
            document.getElementById('calcDiv18').value = 0.7235;
            document.getElementById('calcDiv12').value = 0.7835;
            document.getElementById('calcDiv07').value = 0.8335;
            document.getElementById('calcDivCT').value = 0.9;
            updateCalcPreview();
        }

        // ========== SIMULADOR DE PRE√áOS ==========
        function openSimulator() {
            calculateSimulation();
            document.getElementById('simulatorModal').classList.remove('hidden');
        }
        
        function closeSimulator() {
            document.getElementById('simulatorModal').classList.add('hidden');
        }
        
        function calculateSimulation() {
            const price = parseFloat(document.getElementById('simInputPrice').value) || 0;
            const C = getCommonFactor();
            
            document.getElementById('simFactorBase').textContent = C.toFixed(4);
            document.getElementById('simShowF1').textContent = calcParams.factor1;
            document.getElementById('simShowF2').textContent = calcParams.factor2;
            document.getElementById('simShowF3').textContent = calcParams.factor3;
            document.getElementById('simShowBase').textContent = C.toFixed(4);
            
            const numCorte = C * calcParams.markupCorte * price;
            const numRolo = C * calcParams.markupRolo * price;
            
            const results = {
                '18CRT': { faixa: '18%', tipo: 'Corte', markup: calcParams.markupCorte, divisor: calcParams.div18, preco: numCorte / calcParams.div18 },
                '18ROL': { faixa: '18%', tipo: 'Rolo', markup: calcParams.markupRolo, divisor: calcParams.div18, preco: numRolo / calcParams.div18 },
                '12CRT': { faixa: '12%', tipo: 'Corte', markup: calcParams.markupCorte, divisor: calcParams.div12, preco: numCorte / calcParams.div12 },
                '12ROL': { faixa: '12%', tipo: 'Rolo', markup: calcParams.markupRolo, divisor: calcParams.div12, preco: numRolo / calcParams.div12 },
                '7CRT': { faixa: '7%', tipo: 'Corte', markup: calcParams.markupCorte, divisor: calcParams.div07, preco: numCorte / calcParams.div07 },
                '7ROL': { faixa: '7%', tipo: 'Rolo', markup: calcParams.markupRolo, divisor: calcParams.div07, preco: numRolo / calcParams.div07 },
                'CTCRT': { faixa: 'CT', tipo: 'Corte', markup: calcParams.markupCorte, divisor: calcParams.divCT, preco: numCorte / calcParams.divCT },
                'CTROL': { faixa: 'CT', tipo: 'Rolo', markup: calcParams.markupRolo, divisor: calcParams.divCT, preco: numRolo / calcParams.divCT }
            };
            
            const tbody = document.getElementById('simResultsBody');
            tbody.innerHTML = '';
            
            const colors = { '18%': 'bg-red-50', '12%': 'bg-yellow-50', '7%': 'bg-green-50', 'CT': 'bg-gray-100' };
            
            for (const [key, d] of Object.entries(results)) {
                const formula = `(${C.toFixed(3)} √ó ${d.markup} √ó ${price.toFixed(2)}) √∑ ${d.divisor}`;
                const tr = document.createElement('tr');
                tr.className = colors[d.faixa];
                tr.innerHTML = `
                    <td class="p-2 border">${d.faixa}</td>
                    <td class="p-2 border">${d.tipo}</td>
                    <td class="p-2 border">${d.markup}</td>
                    <td class="p-2 border">${d.divisor}</td>
                    <td class="p-2 border text-xs font-mono">${formula}</td>
                    <td class="p-2 border font-bold text-lg text-orange-700 bg-orange-50">${fmt(d.preco)}</td>
                `;
                tbody.appendChild(tr);
            }
            
            document.getElementById('simCard18CRT').textContent = fmt(results['18CRT'].preco);
            document.getElementById('simCard18ROL').textContent = fmt(results['18ROL'].preco);
            document.getElementById('simCard12CRT').textContent = fmt(results['12CRT'].preco);
            document.getElementById('simCard12ROL').textContent = fmt(results['12ROL'].preco);
            document.getElementById('simCard7CRT').textContent = fmt(results['7CRT'].preco);
            document.getElementById('simCard7ROL').textContent = fmt(results['7ROL'].preco);
            document.getElementById('simCardCTCRT').textContent = fmt(results['CTCRT'].preco);
            document.getElementById('simCardCTROL').textContent = fmt(results['CTROL'].preco);
        }
        
        function copySimulationResult() {
            const price = parseFloat(document.getElementById('simInputPrice').value) || 0;
            const C = getCommonFactor();
            const numCorte = C * calcParams.markupCorte * price;
            const numRolo = C * calcParams.markupRolo * price;
            
            const text = `SIMULADOR - $/m¬≤ ${price}\n18% CRT: ${fmt(numCorte/calcParams.div18)}\n18% ROL: ${fmt(numRolo/calcParams.div18)}\n12% CRT: ${fmt(numCorte/calcParams.div12)}\n12% ROL: ${fmt(numRolo/calcParams.div12)}\n7% CRT: ${fmt(numCorte/calcParams.div07)}\n7% ROL: ${fmt(numRolo/calcParams.div07)}\nCT CRT: ${fmt(numCorte/calcParams.divCT)}\nCT ROL: ${fmt(numRolo/calcParams.divCT)}`;
            navigator.clipboard.writeText(text).then(() => alert('‚úÖ Copiado!'));
        }

        // ========== CLOUD - AN√ÅLISES ==========
        async function loadCloudAnalyses() {
            // An√°lises Simples
            if (CLOUD_CONFIG.URL_SIMPLE) {
                document.getElementById('step-cloud-simple').classList.remove('hidden');
                try {
                    const r = await fetch(CLOUD_CONFIG.URL_SIMPLE + '?action=list');
                    const list = await r.json();
                    renderCloudList('cloudSimpleList', list, 'simple');
                } catch(e) {
                    document.getElementById('cloudSimpleList').innerHTML = '<p class="text-red-600 text-sm">Erro ao carregar</p>';
                }
            }
            
            // Comparativos
            if (CLOUD_CONFIG.URL_COMPARE) {
                document.getElementById('step-cloud-compare').classList.remove('hidden');
                try {
                    const r = await fetch(CLOUD_CONFIG.URL_COMPARE + '?action=list');
                    const list = await r.json();
                    renderCloudList('cloudCompareList', list, 'compare');
                } catch(e) {
                    document.getElementById('cloudCompareList').innerHTML = '<p class="text-red-600 text-sm">Erro ao carregar</p>';
                }
            }
        }
        
        function renderCloudList(containerId, list, mode) {
            const container = document.getElementById(containerId);
            if (!Array.isArray(list) || list.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Nenhuma an√°lise salva.</p>';
                return;
            }
            
            const bgClass = mode === 'simple' ? 'bg-white border-blue-200' : 'bg-white border-green-200';
            const icon = mode === 'simple' ? 'üìä' : 'üîÑ';
            
            container.innerHTML = list.map(a => {
                const date = new Date(a.timestamp).toLocaleString('pt-BR');
                return `
                <div class="${bgClass} border rounded p-3 flex items-center justify-between">
                    <div class="flex-1">
                        <span class="font-bold">${icon} ${a.name || 'Sem nome'}</span>
                        <span class="text-xs text-gray-500 ml-2">(${a.itemCount} itens)</span>
                        <br><span class="text-xs text-gray-400">üë§ ${a.userName || 'An√¥nimo'} | üìÖ ${date}</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="loadFromCloud('${a.id}', '${mode}')" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-sm">Carregar</button>
                        <button onclick="deleteFromCloud('${a.id}', '${mode}')" class="bg-red-400 hover:bg-red-500 text-white px-2 py-1 rounded text-xs">üóëÔ∏è</button>
                    </div>
                </div>`;
            }).join('');
        }
        
        function refreshCloudAnalyses(mode) {
            loadCloudAnalyses();
        }
        
        async function loadFromCloud(id, mode) {
            const url = mode === 'compare' ? CLOUD_CONFIG.URL_COMPARE : CLOUD_CONFIG.URL_SIMPLE;
            try {
                const r = await fetch(url + '?action=load&id=' + id);
                const result = await r.json();
                if (result.error) throw new Error(result.error);
                
                currentAnalysisId = result.id;
                operationMode = mode;
                data = result.data || [];
                if (result.currentData) currentData = result.currentData;
                if (result.newData) newData = result.newData;
                
                if (mode === 'compare') {
                    document.getElementById('compareStats').classList.remove('hidden');
                    document.getElementById('btnExportComparative').classList.remove('hidden');
                }
                
                renderAnalysis();
                showStep('review');
                
                if (CLOUD_CONFIG.URL_SIMPLE || CLOUD_CONFIG.URL_COMPARE) {
                    document.getElementById('btnSaveCloud').classList.remove('hidden');
                }
                
                alert('‚úÖ An√°lise carregada!');
            } catch(e) {
                alert('‚ùå Erro: ' + e.message);
            }
        }
        
        async function deleteFromCloud(id, mode) {
            if (!confirm('Excluir esta an√°lise?')) return;
            const url = mode === 'compare' ? CLOUD_CONFIG.URL_COMPARE : CLOUD_CONFIG.URL_SIMPLE;
            try {
                await fetch(url + '?action=delete&id=' + id);
                loadCloudAnalyses();
            } catch(e) {
                alert('‚ùå Erro: ' + e.message);
            }
        }
        
        async function saveToCloud() {
            const url = operationMode === 'compare' ? CLOUD_CONFIG.URL_COMPARE : CLOUD_CONFIG.URL_SIMPLE;
            if (!url) {
                alert('‚ö†Ô∏è URL da nuvem n√£o configurada para este modo!');
                return;
            }
            
            const name = prompt('Nome desta an√°lise:');
            if (!name) return;
            
            const btn = document.getElementById('btnSaveCloud');
            btn.innerHTML = '‚è≥ Salvando...';
            btn.disabled = true;
            
            try {
                const payload = {
                    action: 'save',
                    mode: operationMode,
                    id: currentAnalysisId || (operationMode + '_' + Date.now()),
                    name: name,
                    fileNames: name,
                    userName: CLOUD_CONFIG.DEFAULT_USER || 'Usu√°rio',
                    itemCount: data.length,
                    data: data,
                    currentData: currentData,
                    newData: newData
                };
                
                const response = await fetch(url, {
                    method: 'POST',
                    mode: 'cors',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });
                
                const text = await response.text();
                const result = JSON.parse(text);
                
                if (result.success) {
                    currentAnalysisId = result.id;
                    alert('‚úÖ Salvo na nuvem!');
                    loadCloudAnalyses();
                } else {
                    throw new Error(result.error || 'Erro desconhecido');
                }
            } catch(e) {
                alert('‚ùå Erro ao salvar: ' + e.message);
            } finally {
                btn.innerHTML = '‚òÅÔ∏è Salvar na Nuvem';
                btn.disabled = false;
            }
        }

        // ========== CACHE LOCAL ==========
        function checkCachedData() {
            const cacheSimple = localStorage.getItem('centralMesh_simple');
            const cacheCompare = localStorage.getItem('centralMesh_compare');
            
            if (!cacheSimple && !cacheCompare) return;
            
            let html = '';
            
            if (cacheSimple) {
                const p = JSON.parse(cacheSimple);
                html += `<div class="bg-blue-50 border border-blue-300 rounded p-3 mb-2 flex justify-between items-center">
                    <div><strong>üìä An√°lise Simples</strong> (${p.data?.length || 0} itens)<br><span class="text-xs text-gray-500">${new Date(p.timestamp).toLocaleString('pt-BR')}</span></div>
                    <div><button onclick="loadCachedData('simple')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm mr-2">Carregar</button><button onclick="clearCache('simple')" class="text-red-500 text-sm">üóëÔ∏è</button></div>
                </div>`;
            }
            
            if (cacheCompare) {
                const p = JSON.parse(cacheCompare);
                html += `<div class="bg-green-50 border border-green-300 rounded p-3 flex justify-between items-center">
                    <div><strong>üîÑ Comparativo</strong> (${p.data?.length || 0} itens)<br><span class="text-xs text-gray-500">${new Date(p.timestamp).toLocaleString('pt-BR')}</span></div>
                    <div><button onclick="loadCachedData('compare')" class="bg-green-500 text-white px-3 py-1 rounded text-sm mr-2">Carregar</button><button onclick="clearCache('compare')" class="text-red-500 text-sm">üóëÔ∏è</button></div>
                </div>`;
            }
            
            document.getElementById('cacheInfo').innerHTML = html;
            document.getElementById('step-cached').classList.remove('hidden');
        }
        
        function loadCachedData(mode) {
            const key = mode === 'compare' ? 'centralMesh_compare' : 'centralMesh_simple';
            const p = JSON.parse(localStorage.getItem(key));
            
            operationMode = mode;
            data = p.data || [];
            currentData = p.currentData || [];
            newData = p.newData || [];
            
            if (mode === 'compare') {
                document.getElementById('compareStats').classList.remove('hidden');
                document.getElementById('btnExportComparative').classList.remove('hidden');
            }
            
            renderAnalysis();
            showStep('review');
            
            if (CLOUD_CONFIG.URL_SIMPLE || CLOUD_CONFIG.URL_COMPARE) {
                document.getElementById('btnSaveCloud').classList.remove('hidden');
            }
        }
        
        function saveToCache() {
            const key = operationMode === 'compare' ? 'centralMesh_compare' : 'centralMesh_simple';
            localStorage.setItem(key, JSON.stringify({
                timestamp: new Date().toISOString(),
                mode: operationMode,
                data: data,
                currentData: currentData,
                newData: newData
            }));
        }
        
        function clearCache(mode) {
            const key = mode === 'compare' ? 'centralMesh_compare' : 'centralMesh_simple';
            localStorage.removeItem(key);
            checkCachedData();
        }

        // ========== UI HELPERS ==========
        function showStep(step) {
            ['step-mode', 'step-input', 'step-review', 'step-report', 'step-cached', 'step-cloud-simple', 'step-cloud-compare', 'step-config-warning'].forEach(s => {
                const el = document.getElementById(s);
                if (el) el.classList.add('hidden');
            });
            
            if (step === 'mode') {
                document.getElementById('step-mode').classList.remove('hidden');
                checkCachedData();
                loadCloudAnalyses();
            } else if (step === 'input') {
                document.getElementById('step-input').classList.remove('hidden');
            } else if (step === 'review') {
                document.getElementById('step-review').classList.remove('hidden');
            } else if (step === 'report') {
                document.getElementById('step-report').classList.remove('hidden');
            }
        }
        
        function selectMode(mode) {
            operationMode = mode;
            
            document.getElementById('modeSimple').classList.remove('border-orange-500', 'bg-orange-50');
            document.getElementById('modeCompare').classList.remove('border-orange-500', 'bg-orange-50');
            
            if (mode === 'simple') {
                document.getElementById('modeSimple').classList.add('border-orange-500', 'bg-orange-50');
                document.getElementById('inputSimple').classList.remove('hidden');
                document.getElementById('inputCompare').classList.add('hidden');
            } else {
                document.getElementById('modeCompare').classList.add('border-orange-500', 'bg-orange-50');
                document.getElementById('inputSimple').classList.add('hidden');
                document.getElementById('inputCompare').classList.remove('hidden');
            }
            
            showStep('input');
        }
        
        function goBackToMode() {
            showStep('mode');
        }

        // ========== UTILIT√ÅRIOS ==========
        function fmt(n) {
            if (n === null || n === undefined || isNaN(n)) return '-';
            return n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        function parseNum(v) {
            if (v === null || v === undefined) return 0;
            if (typeof v === 'number') return v;
            let s = String(v).replace(/[R$\s]/g, '').trim();
            if (s.includes(',') && s.includes('.')) {
                s = s.replace(/\./g, '').replace(',', '.');
            } else if (s.includes(',')) {
                s = s.replace(',', '.');
            }
            return parseFloat(s) || 0;
        }
        
        function normalizeStr(s) {
            return String(s || '').trim().toUpperCase();
        }

        // ========== PROCESSAMENTO DE ARQUIVOS ==========
        function downloadTemplate() {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([['C√ìDIGO SIL√ìGICA', 'MATERIAL', 'MALHA', 'FIO/mm', 'LARGURA', '$/m2']]);
            XLSX.utils.book_append_sheet(wb, ws, 'Modelo');
            XLSX.writeFile(wb, 'modelo_central_mesh.xlsx');
        }
        
        function readExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        resolve(XLSX.utils.sheet_to_json(ws, { header: 1 }));
                    } catch(err) { reject(err); }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
        
        async function processFiles() {
            try {
                if (operationMode === 'simple') {
                    const file = document.getElementById('fileInput').files[0];
                    if (!file) return alert('Selecione um arquivo!');
                    data = parseData(await readExcel(file));
                    analyzeData();
                } else {
                    const fileCurrent = document.getElementById('fileCurrentInput').files[0];
                    const fileNew = document.getElementById('fileNewInput').files[0];
                    if (!fileCurrent || !fileNew) return alert('Selecione ambos os arquivos!');
                    currentData = parseData(await readExcel(fileCurrent));
                    newData = parseData(await readExcel(fileNew));
                    compareData();
                    document.getElementById('compareStats').classList.remove('hidden');
                    document.getElementById('btnExportComparative').classList.remove('hidden');
                }
                
                saveToCache();
                renderAnalysis();
                showStep('review');
                
                if (CLOUD_CONFIG.URL_SIMPLE || CLOUD_CONFIG.URL_COMPARE) {
                    document.getElementById('btnSaveCloud').classList.remove('hidden');
                }
            } catch(e) {
                alert('Erro: ' + e.message);
            }
        }
        
        function parseData(rows) {
            if (rows.length < 2) return [];
            
            const h = rows[0].map(x => String(x || '').toUpperCase().trim());
            const find = keys => {
                let i = h.findIndex(x => keys.some(k => x === k));
                if (i === -1) i = h.findIndex(x => keys.some(k => x.includes(k)));
                return i;
            };
            
            const iCode = find(['C√ìDIGO SIL√ìGICA', 'CODIGO SILOGICA', 'C√ìDIGO', 'CODIGO', 'COD']);
            const iMat = find(['MATERIAL', 'MAT']);
            const iMesh = find(['MALHA', 'MESH']);
            const iWire = find(['FIO/MM', 'FIO', 'WIRE']);
            const iWidth = find(['LARGURA', 'LARG', 'WIDTH']);
            const iPrice = find(['$/M2', '$/M¬≤', 'PRECO', 'PRE√áO', 'VALOR', 'M2']);
            
            let actualMatIdx = iMat;
            let actualPriceIdx = iPrice;
            
            if (actualMatIdx === -1) {
                for (let i = 0; i < h.length; i++) {
                    if (i !== iCode && rows[1] && typeof rows[1][i] === 'string') {
                        actualMatIdx = i;
                        break;
                    }
                }
            }
            
            if (actualPriceIdx === -1) {
                for (let i = h.length - 1; i >= 0; i--) {
                    if (rows[1] && typeof rows[1][i] === 'number') {
                        actualPriceIdx = i;
                        break;
                    }
                }
            }
            
            if (actualMatIdx === -1 || actualPriceIdx === -1) {
                throw new Error('Colunas MATERIAL e $/m2 n√£o encontradas! Cabe√ßalhos: ' + h.join(', '));
            }
            
            const result = [];
            for (let i = 1; i < rows.length; i++) {
                const r = rows[i];
                if (!r || !r.length) continue;
                
                const get = idx => idx >= 0 && r[idx] !== undefined ? r[idx] : '';
                const price = parseNum(get(actualPriceIdx));
                const material = get(actualMatIdx);
                
                if (!material && price === 0) continue;
                
                result.push({
                    id: i,
                    code: String(get(iCode) || '-').trim(),
                    material: String(material || 'N/A').trim(),
                    mesh: String(get(iMesh) || '-').trim(),
                    wire: String(get(iWire) || '-').trim(),
                    width: String(get(iWidth) || '-').trim(),
                    price: price,
                    originalPrice: price,
                    priceOld: null,
                    isEmpty: price === 0,
                    isEdited: false,
                    anomaly: false,
                    reasons: [],
                    changeType: null,
                    pendingRemoval: false
                });
            }
            return result;
        }

        // ========== AN√ÅLISE ==========
        function getMaterialRank(m) {
            if (!m) return 0;
            const u = String(m).toUpperCase();
            if (u.includes('316')) return 40;
            if (u.includes('304')) return 30;
            if (u.includes('302')) return 20;
            if (u.includes('GALV') || u.includes('CARB')) return 10;
            return 0;
        }
        
        function analyzeData() {
            // Agrupar por Material + Malha + Fio
            const groups = {};
            data.forEach(item => {
                const key = item.material + '|' + item.mesh + '|' + item.wire;
                if (!groups[key]) groups[key] = [];
                groups[key].push(item);
            });
            
            // Fase 1: Varia√ß√£o de Larguras
            for (let key in groups) {
                const g = groups[key];
                if (g.length < 2) continue;
                
                const validPrices = g.filter(x => x.price > 0).map(x => x.price);
                if (validPrices.length === 0) continue;
                const avg = validPrices.reduce((s, x) => s + x, 0) / validPrices.length;
                
                g.forEach(item => {
                    if (item.price > 0 && avg > 0) {
                        const diff = Math.abs((item.price - avg) / avg);
                        if (diff > 0.15) {
                            item.anomaly = true;
                            item.reasons.push('Pre√ßo ' + Math.round(diff * 100) + '% ' + (item.price > avg ? 'acima' : 'abaixo') + ' da m√©dia do grupo');
                        }
                    }
                });
            }
            
            // Fase 2: Hierarquia de Materiais
            const specMap = {};
            data.forEach(item => {
                const key = item.mesh + '-' + item.wire + '-' + item.width;
                if (!specMap[key]) specMap[key] = [];
                specMap[key].push(item);
            });
            
            for (let key in specMap) {
                const items = specMap[key];
                if (items.length < 2) continue;
                items.sort((a, b) => getMaterialRank(a.material) - getMaterialRank(b.material));
                
                for (let i = 0; i < items.length; i++) {
                    for (let j = i + 1; j < items.length; j++) {
                        const lower = items[i], higher = items[j];
                        if (getMaterialRank(higher.material) > getMaterialRank(lower.material)) {
                            if (lower.price > higher.price * 1.05) {
                                lower.anomaly = true;
                                lower.reasons.push('Incoer√™ncia: ' + lower.material + ' mais caro que ' + higher.material);
                                higher.anomaly = true;
                                higher.reasons.push('Incoer√™ncia: ' + higher.material + ' mais barato que ' + lower.material);
                            }
                        }
                    }
                }
            }
            
            // Marcar vazios
            data.forEach(item => {
                if (item.price === 0) {
                    item.isEmpty = true;
                    item.anomaly = true;
                    if (!item.reasons.includes('Pre√ßo em branco')) item.reasons.push('Pre√ßo em branco');
                }
            });
            
            updateCounters();
        }
        
        function compareData() {
            const currentMap = {};
            currentData.forEach(item => {
                const key = normalizeStr(item.code) + '|' + normalizeStr(item.material) + '|' + normalizeStr(item.mesh) + '|' + normalizeStr(item.wire) + '|' + normalizeStr(item.width);
                currentMap[key] = item;
            });
            
            data = [];
            
            // Processar novos
            newData.forEach(newItem => {
                const key = normalizeStr(newItem.code) + '|' + normalizeStr(newItem.material) + '|' + normalizeStr(newItem.mesh) + '|' + normalizeStr(newItem.wire) + '|' + normalizeStr(newItem.width);
                const currentItem = currentMap[key];
                
                if (currentItem) {
                    if (Math.abs(newItem.price - currentItem.price) > 0.01) {
                        newItem.priceOld = currentItem.price;
                        newItem.changeType = 'changed';
                        newItem.anomaly = true;
                        newItem.reasons.push('Pre√ßo alterado');
                    }
                    delete currentMap[key];
                } else {
                    newItem.changeType = 'new';
                    newItem.anomaly = true;
                    newItem.reasons.push('Item novo');
                }
                
                if (newItem.price === 0) {
                    newItem.isEmpty = true;
                    if (!newItem.reasons.includes('Pre√ßo em branco')) newItem.reasons.push('Pre√ßo em branco');
                }
                
                data.push(newItem);
            });
            
            // Itens removidos
            for (let key in currentMap) {
                const item = currentMap[key];
                item.changeType = 'removed';
                item.pendingRemoval = true;
                item.anomaly = true;
                item.reasons.push('N√£o existe na nova tabela');
                data.push(item);
            }
            
            updateCounters();
        }
        
        function updateCounters() {
            document.getElementById('anomalyCount').textContent = data.filter(x => x.anomaly && !x.isEmpty).length;
            document.getElementById('emptyCount').textContent = data.filter(x => x.isEmpty).length;
            document.getElementById('totalCount').textContent = data.length;
            
            if (operationMode === 'compare') {
                document.getElementById('changedCount').textContent = data.filter(x => x.changeType === 'changed').length;
                document.getElementById('newCount').textContent = data.filter(x => x.changeType === 'new').length;
                document.getElementById('removedCount').textContent = data.filter(x => x.pendingRemoval).length;
            }
        }

        // ========== RENDER ==========
        function renderAnalysis() {
            const tbody = document.getElementById('analysisBody');
            tbody.innerHTML = '';
            
            populateAnalysisFilters();
            
            const sorted = [...data].sort((a, b) => {
                const matA = String(a.material || ''), matB = String(b.material || '');
                if (matA !== matB) return matA.localeCompare(matB);
                if (a.mesh !== b.mesh) return parseFloat(a.mesh) - parseFloat(b.mesh);
                if (a.wire !== b.wire) return parseFloat(a.wire) - parseFloat(b.wire);
                return parseFloat(a.width) - parseFloat(b.width);
            });
            
            let lastMat = null;
            sorted.forEach((item, i) => {
                const idx = data.indexOf(item);
                
                if (lastMat && lastMat !== item.material) {
                    const sep = document.createElement('tr');
                    sep.className = 'bg-orange-200 separator-row';
                    sep.innerHTML = `<td colspan="13" class="p-2 text-center text-xs font-bold text-orange-800">‚îÄ‚îÄ ${item.material} ‚îÄ‚îÄ</td>`;
                    tbody.appendChild(sep);
                }
                lastMat = item.material;
                
                const tr = document.createElement('tr');
                tr.setAttribute('data-idx', idx);
                
                let bgClass = '';
                if (item.isEmpty) bgClass = 'row-empty';
                else if (item.isEdited) bgClass = 'row-changed';
                else if (item.pendingRemoval) bgClass = 'bg-yellow-50';
                else if (item.changeType === 'new') bgClass = 'bg-green-50';
                else if (item.changeType === 'changed') bgClass = 'bg-blue-50';
                else if (item.anomaly) bgClass = 'bg-red-50';
                tr.className = bgClass;
                
                let inputClass = 'price-input w-20 p-1 border rounded text-center font-bold';
                if (item.isEmpty) inputClass += ' empty';
                else if (item.isEdited) inputClass += ' changed';
                
                const statusLabel = item.isEmpty ? '<span class="bg-orange-100 text-orange-700 px-2 py-0.5 rounded text-xs">Vazio</span>' :
                                   item.isEdited ? '<span class="bg-amber-100 text-amber-700 px-2 py-0.5 rounded text-xs">Editado</span>' :
                                   item.anomaly ? '<span class="bg-red-100 text-red-700 px-2 py-0.5 rounded text-xs">Revisar</span>' :
                                   '<span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs">OK</span>';
                
                const typeLabel = item.pendingRemoval ? '<span class="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded text-xs">P/ Remover</span>' :
                                 item.changeType === 'changed' ? '<span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs">Alterado</span>' :
                                 item.changeType === 'new' ? '<span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs">Novo</span>' :
                                 item.changeType === 'removed' ? '<span class="bg-gray-200 text-gray-600 px-2 py-0.5 rounded text-xs">Removido</span>' : '-';
                
                let variation = '-';
                if (item.priceOld !== null && item.priceOld > 0) {
                    const pct = ((item.price - item.priceOld) / item.priceOld) * 100;
                    const cls = pct > 0 ? 'text-red-600' : 'text-green-600';
                    variation = `<span class="${cls} font-medium">${pct > 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(pct).toFixed(1)}%</span>`;
                }
                
                let actionHtml = '';
                if (item.pendingRemoval) {
                    actionHtml = `<button onclick="confirmRemoval(${idx})" class="bg-red-500 text-white px-2 py-1 rounded text-xs mr-1">Remover</button><button onclick="keepItem(${idx})" class="bg-blue-500 text-white px-2 py-1 rounded text-xs">Manter</button>`;
                } else if (item.isEdited) {
                    actionHtml = `<button onclick="resetPrice(${idx})" class="bg-gray-500 text-white px-2 py-1 rounded text-xs">Desfazer</button>`;
                }
                
                tr.innerHTML = `
                    <td class="p-2 border">${statusLabel}</td>
                    <td class="p-2 border">${typeLabel}</td>
                    <td class="p-2 border font-mono text-xs">${item.code}</td>
                    <td class="p-2 border font-bold text-orange-700">${item.material}</td>
                    <td class="p-2 border text-center">${item.mesh}</td>
                    <td class="p-2 border text-center">${item.wire}</td>
                    <td class="p-2 border text-center">${item.width}</td>
                    <td class="p-2 border text-center text-gray-500">${item.priceOld !== null ? '$' + fmt(item.priceOld) : '-'}</td>
                    <td class="p-2 border text-center ${item.anomaly && !item.isEdited ? 'text-red-600 font-bold' : ''}">${item.originalPrice > 0 ? '$' + fmt(item.originalPrice) : '-'}</td>
                    <td class="p-2 border text-center">${variation}</td>
                    <td class="p-2 border text-center bg-yellow-50"><input type="number" step="0.01" value="${item.price || ''}" onchange="updatePrice(${idx}, this.value)" class="${inputClass}" placeholder="0,00"></td>
                    <td class="p-2 border text-xs text-red-600">${item.reasons.join('; ')}</td>
                    <td class="p-2 border text-center">${actionHtml}</td>
                `;
                tbody.appendChild(tr);
            });
            
            updateCounters();
            applyAnalysisFilters();
        }
        
        function populateAnalysisFilters() {
            const mats = [...new Set(data.map(x => x.material))].sort();
            const meshes = [...new Set(data.map(x => x.mesh))].sort((a, b) => parseFloat(a) - parseFloat(b));
            const wires = [...new Set(data.map(x => x.wire))].sort((a, b) => parseFloat(a) - parseFloat(b));
            const widths = [...new Set(data.map(x => x.width))].sort((a, b) => parseFloat(a) - parseFloat(b));
            
            const fillSel = (id, opts, label) => {
                const sel = document.getElementById(id);
                sel.innerHTML = `<option value="">${label}</option>` + opts.map(o => `<option value="${o}">${o}</option>`).join('');
            };
            
            fillSel('aFilterMaterial', mats, 'Todos Materiais');
            fillSel('aFilterMesh', meshes, 'Todas Malhas');
            fillSel('aFilterWire', wires, 'Todos Fios');
            fillSel('aFilterWidth', widths, 'Todas Larguras');
        }
        
        function applyAnalysisFilters() {
            const mat = document.getElementById('aFilterMaterial').value;
            const mesh = document.getElementById('aFilterMesh').value;
            const wire = document.getElementById('aFilterWire').value;
            const width = document.getElementById('aFilterWidth').value;
            const status = document.getElementById('aFilterStatus').value;
            
            let visible = 0, problems = 0;
            
            document.querySelectorAll('#analysisBody tr').forEach(row => {
                if (row.classList.contains('separator-row')) {
                    row.style.display = 'none';
                    return;
                }
                
                const idx = parseInt(row.getAttribute('data-idx'));
                if (isNaN(idx)) return;
                const item = data[idx];
                
                let show = true;
                if (mat && item.material !== mat) show = false;
                if (mesh && item.mesh !== mesh) show = false;
                if (wire && item.wire !== wire) show = false;
                if (width && item.width !== width) show = false;
                
                if (status === 'revisar' && (!item.anomaly || item.isEmpty)) show = false;
                if (status === 'vazio' && !item.isEmpty) show = false;
                if (status === 'alterado' && item.changeType !== 'changed') show = false;
                if (status === 'novo' && item.changeType !== 'new') show = false;
                if (status === 'removido' && !item.pendingRemoval) show = false;
                if (status === 'editado' && !item.isEdited) show = false;
                if (status === 'ok' && (item.anomaly || item.isEmpty || item.isEdited)) show = false;
                
                row.style.display = show ? '' : 'none';
                if (show) {
                    visible++;
                    if (item.anomaly || item.isEmpty) problems++;
                }
            });
            
            document.getElementById('filteredCount').textContent = `Exibindo: ${visible} itens (${problems} p/ revisar)`;
        }
        
        function clearAnalysisFilters() {
            document.getElementById('aFilterMaterial').value = '';
            document.getElementById('aFilterMesh').value = '';
            document.getElementById('aFilterWire').value = '';
            document.getElementById('aFilterWidth').value = '';
            document.getElementById('aFilterStatus').value = '';
            applyAnalysisFilters();
        }
        
        function updatePrice(idx, value) {
            const item = data[idx];
            const newPrice = parseFloat(value) || 0;
            item.price = newPrice;
            item.isEdited = newPrice !== item.originalPrice;
            item.isEmpty = newPrice === 0;
            saveToCache();
            
            const row = document.querySelector(`tr[data-idx="${idx}"]`);
            if (row) {
                row.className = item.isEmpty ? 'row-empty' : item.isEdited ? 'row-changed' : item.anomaly ? 'bg-red-50' : '';
            }
            
            updateCounters();
            applyAnalysisFilters();
        }
        
        function resetPrice(idx) {
            const item = data[idx];
            item.price = item.originalPrice;
            item.isEdited = false;
            item.isEmpty = item.price === 0;
            saveToCache();
            renderAnalysis();
        }
        
        function confirmRemoval(idx) {
            data[idx].pendingRemoval = false;
            data[idx].changeType = 'removed';
            data[idx].anomaly = false;
            data[idx].reasons = ['Remo√ß√£o aprovada'];
            saveToCache();
            renderAnalysis();
        }
        
        function keepItem(idx) {
            data[idx].pendingRemoval = false;
            data[idx].changeType = null;
            data[idx].anomaly = false;
            data[idx].reasons = ['Mantido'];
            saveToCache();
            renderAnalysis();
        }

        // ========== EXPORTAR COMPARATIVO ==========
        function exportComparative() {
            const rows = [['C√ìDIGO', 'MATERIAL', 'MALHA', 'FIO', 'LARGURA', '$/m¬≤ ANTERIOR', '$/m¬≤ NOVO', 'VARIA√á√ÉO %', 'STATUS', 'OBSERVA√á√ÉO']];
            
            data.forEach(item => {
                let status = 'OK';
                if (item.changeType === 'changed') status = 'ALTERADO';
                if (item.changeType === 'new') status = 'NOVO';
                if (item.pendingRemoval) status = 'P/ REMOVER';
                if (item.isEmpty) status = 'VAZIO';
                if (item.isEdited) status = 'EDITADO';
                
                let variation = '-';
                if (item.priceOld && item.priceOld > 0) {
                    variation = (((item.price - item.priceOld) / item.priceOld) * 100).toFixed(2) + '%';
                }
                
                rows.push([item.code, item.material, item.mesh, item.wire, item.width, item.priceOld || '-', item.price, variation, status, item.reasons.join('; ')]);
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(rows);
            XLSX.utils.book_append_sheet(wb, ws, 'Comparativo');
            XLSX.writeFile(wb, 'comparativo_precos.xlsx');
        }

        // ========== RELAT√ìRIO FINAL ==========
        function generateReport() {
            const finalData = data.filter(x => x.changeType !== 'removed');
            
            const tbody = document.getElementById('reportBody');
            tbody.innerHTML = '';
            document.getElementById('reportDate').textContent = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });
            
            const C = getCommonFactor();
            const MCRT = calcParams.markupCorte, MROL = calcParams.markupRolo;
            const D18 = calcParams.div18, D12 = calcParams.div12, D07 = calcParams.div07, DCT = calcParams.divCT;
            
            finalData.sort((a, b) => {
                const matA = String(a.material || ''), matB = String(b.material || '');
                if (matA !== matB) return matA.localeCompare(matB);
                return parseFloat(a.mesh) - parseFloat(b.mesh);
            });
            
            const mats = [], meshes = [], wires = [], widths = [];
            
            finalData.forEach(item => {
                const b = item.price || 0;
                const nCrt = C * MCRT * b;
                const nRol = C * MROL * b;
                
                if (!mats.includes(item.material)) mats.push(item.material);
                if (!meshes.includes(item.mesh)) meshes.push(item.mesh);
                if (!wires.includes(item.wire)) wires.push(item.wire);
                if (!widths.includes(item.width)) widths.push(item.width);
                
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-orange-50';
                tr.innerHTML = `
                    <td class="p-1 border text-xs">${item.code}</td>
                    <td class="p-1 border text-xs font-bold">${item.material}</td>
                    <td class="p-1 border text-xs text-center">${item.mesh}</td>
                    <td class="p-1 border text-xs text-center">${item.wire}</td>
                    <td class="p-1 border text-xs text-center">${item.width}</td>
                    <td class="p-1 border text-xs text-right bg-gray-100 hide-for-vendors">${fmt(b)}</td>
                    <td class="p-1 border text-xs text-right">${fmt(nCrt / D18)}</td>
                    <td class="p-1 border text-xs text-right">${fmt(nRol / D18)}</td>
                    <td class="p-1 border text-xs text-right">${fmt(nCrt / D12)}</td>
                    <td class="p-1 border text-xs text-right">${fmt(nRol / D12)}</td>
                    <td class="p-1 border text-xs text-right">${fmt(nCrt / D07)}</td>
                    <td class="p-1 border text-xs text-right">${fmt(nRol / D07)}</td>
                    <td class="p-1 border text-xs text-right hide-for-vendors">${fmt(nCrt / DCT)}</td>
                    <td class="p-1 border text-xs text-right hide-for-vendors">${fmt(nRol / DCT)}</td>
                `;
                tbody.appendChild(tr);
            });
            
            // Preencher filtros
            const fillSel = (id, opts) => {
                const sel = document.getElementById(id);
                sel.innerHTML = '<option value="">Todos</option>' + opts.map(o => `<option value="${o}">${o}</option>`).join('');
            };
            
            fillSel('fMaterial', mats.sort());
            fillSel('fMesh', meshes.sort((a, b) => parseFloat(a) - parseFloat(b)));
            fillSel('fWire', wires.sort((a, b) => parseFloat(a) - parseFloat(b)));
            fillSel('fWidth', widths.sort((a, b) => parseFloat(a) - parseFloat(b)));
            
            data = finalData;
            showStep('report');
        }
        
        function applyFilters() {
            const code = document.getElementById('fCode').value.toUpperCase();
            const mat = document.getElementById('fMaterial').value;
            const mesh = document.getElementById('fMesh').value;
            const wire = document.getElementById('fWire').value;
            const width = document.getElementById('fWidth').value;
            
            document.querySelectorAll('#reportBody tr').forEach(row => {
                const cells = row.cells;
                let show = true;
                if (code && !cells[0].textContent.toUpperCase().includes(code)) show = false;
                if (mat && cells[1].textContent !== mat) show = false;
                if (mesh && cells[2].textContent !== mesh) show = false;
                if (wire && cells[3].textContent !== wire) show = false;
                if (width && cells[4].textContent !== width) show = false;
                row.style.display = show ? '' : 'none';
            });
        }
        
        function clearFilters() {
            document.getElementById('fCode').value = '';
            document.getElementById('fMaterial').value = '';
            document.getElementById('fMesh').value = '';
            document.getElementById('fWire').value = '';
            document.getElementById('fWidth').value = '';
            applyFilters();
        }
        
        function exportExcel() {
            const C = getCommonFactor();
            const MCRT = calcParams.markupCorte, MROL = calcParams.markupRolo;
            const D18 = calcParams.div18, D12 = calcParams.div12, D07 = calcParams.div07, DCT = calcParams.divCT;
            
            const rows = [['C√ìDIGO', 'MATERIAL', 'MALHA', 'FIO', 'LARGURA', '$/m¬≤', '18% CRT', '18% ROL', '12% CRT', '12% ROL', '7% CRT', '7% ROL', 'CT CRT', 'CT ROL']];
            
            data.forEach(item => {
                const b = item.price || 0;
                const nCrt = C * MCRT * b;
                const nRol = C * MROL * b;
                rows.push([item.code, item.material, item.mesh, item.wire, item.width, b, nCrt / D18, nRol / D18, nCrt / D12, nRol / D12, nCrt / D07, nRol / D07, nCrt / DCT, nRol / DCT]);
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(rows);
            XLSX.utils.book_append_sheet(wb, ws, 'Tabela');
            XLSX.writeFile(wb, 'tabela_central_mesh.xlsx');
        }

        // ========== PUBLICA√á√ÉO ==========
        function pubComplete() {
            document.querySelector('nav').classList.add('hidden');
            document.getElementById('adminButtons').classList.add('hidden');
            document.getElementById('publicFooter').classList.remove('hidden');
            document.getElementById('step-report').classList.remove('vendors-mode');
        }
        
        function pubVendors() {
            document.querySelector('nav').classList.add('hidden');
            document.getElementById('adminButtons').classList.add('hidden');
            document.getElementById('publicFooter').classList.remove('hidden');
            document.getElementById('step-report').classList.add('vendors-mode');
        }
        
        function copyCodeComplete() {
            const html = document.getElementById('step-report').outerHTML;
            const code = `<!DOCTYPE html><html lang="pt-BR"><head><meta charset="UTF-8"><script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"><\/script><script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"><\/script></head><body class="p-4">${html}<script>function applyFilters(){const c=document.getElementById('fCode').value.toUpperCase(),m=document.getElementById('fMaterial').value,h=document.getElementById('fMesh').value,w=document.getElementById('fWire').value,l=document.getElementById('fWidth').value;document.querySelectorAll('#reportBody tr').forEach(r=>{const x=r.cells;let s=true;if(c&&!x[0].textContent.toUpperCase().includes(c))s=false;if(m&&x[1].textContent!==m)s=false;if(h&&x[2].textContent!==h)s=false;if(w&&x[3].textContent!==w)s=false;if(l&&x[4].textContent!==l)s=false;r.style.display=s?'':'none'});}function clearFilters(){document.getElementById('fCode').value='';document.getElementById('fMaterial').value='';document.getElementById('fMesh').value='';document.getElementById('fWire').value='';document.getElementById('fWidth').value='';applyFilters();}function exportExcel(){const t=document.getElementById('reportTable');const wb=XLSX.utils.table_to_book(t);XLSX.writeFile(wb,'tabela.xlsx');}<\/script></body></html>`;
            navigator.clipboard.writeText(code).then(() => alert('‚úÖ C√≥digo completo copiado!'));
        }
        
        function copyCodeVendors() {
            const html = document.getElementById('step-report').outerHTML;
            const code = `<!DOCTYPE html><html lang="pt-BR"><head><meta charset="UTF-8"><script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"><\/script><script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"><\/script><style>.hide-for-vendors{display:none!important}</style></head><body class="p-4">${html}<script>function applyFilters(){const c=document.getElementById('fCode').value.toUpperCase(),m=document.getElementById('fMaterial').value,h=document.getElementById('fMesh').value,w=document.getElementById('fWire').value,l=document.getElementById('fWidth').value;document.querySelectorAll('#reportBody tr').forEach(r=>{const x=r.cells;let s=true;if(c&&!x[0].textContent.toUpperCase().includes(c))s=false;if(m&&x[1].textContent!==m)s=false;if(h&&x[2].textContent!==h)s=false;if(w&&x[3].textContent!==w)s=false;if(l&&x[4].textContent!==l)s=false;r.style.display=s?'':'none'});}function clearFilters(){document.getElementById('fCode').value='';document.getElementById('fMaterial').value='';document.getElementById('fMesh').value='';document.getElementById('fWire').value='';document.getElementById('fWidth').value='';applyFilters();}function exportExcel(){const t=document.getElementById('reportTable');const wb=XLSX.utils.table_to_book(t);XLSX.writeFile(wb,'tabela.xlsx');}<\/script></body></html>`;
            navigator.clipboard.writeText(code).then(() => alert('‚úÖ C√≥digo vendedores copiado!'));
        }
    </script>
</body>
</html>
